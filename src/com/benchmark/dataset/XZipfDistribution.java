package com.benchmark.dataset;

import java.io.FileWriter;
import java.util.Hashtable;

import org.apache.commons.math3.distribution.ZipfDistribution;
import org.apache.commons.math3.random.RandomData;
import org.apache.commons.math3.random.RandomDataImpl;
import org.apache.commons.math3.random.RandomGenerator;
/**
 * 1 generate x with the zipf distribution
 * 2 get the x-value frequency, and make it as the number of y-value
 * 3 combine the (x,y) as the coordination of point.
 * If the number of points is 10,000,000, so the input is zipf(10,000,000, 1), but the value is [1,10,000,000],
 * so, in the end, should normalize the value to [0,100) 
 * 
 * @author dan
 *
 */


public class XZipfDistribution {

	String fileNamePrefix = "zipf";
	String fileNameSuffix = ".dat";
	
	/**
	 * this is the first one, but it consumes much time
	 * @param number
	 * @param min
	 * @param max
	 * @param outputFolder
	 * @return
	 */
	public String expoGenerate(int number,int min, int max,String outputFolder){
		
		if(outputFolder != null){
			fileNamePrefix = outputFolder+"/"+fileNamePrefix;
		}
		
		RandomDataImpl randomData1 = new RandomDataImpl(); 
		double x[] = new double[number*2];
		double y[] = new double[number*2];
		double stat_x[] = new double[number];
		double stat_y[] = new double[number];
		for(int i=0;i<number*2;i++){
			x[i] = 0;
			y[i] = 0;
			if(i<number){
				stat_x[i] = 0;
				stat_y[i] = 0;
			}			
		}			
		
		ZipfDistribution zipf = new ZipfDistribution(number,1);		
		int total = 0;
		for(int i=0;i<number;i++){		
			double probability = zipf.probability(i);			
			long count = Math.round((probability*number)+0.5); 
			stat_x[i] = count;
			RandomDataImpl randomData2 = new RandomDataImpl();
			randomData2.reSeed(i);
			randomData1.reSeed(i);
			for(int j=0;j<count;j++){
				x[total] = i+randomData1.nextUniform(0, 1);
				//int yy = (int)(randomData2.nextZipf((int)count, 1)*(number/count));
				int yy = randomData2.nextZipf((int)count, 1);
				if(yy == number)
					yy = yy -1;				
				stat_y[yy]++;
				y[total] = yy+randomData2.nextUniform(0, 1);
				
			//	System.out.println(x[total]+","+y[total]+"==="+x[total] / (number/max)+";"+y[total] / (number/max));
				total++;									
			}
				
		}
		
		System.out.println(total);
		// normailze the value into the given value range
		System.out.println("===normalized==and start to write=");
		FileWriter fw = null;
		FileWriter xstatFile = null;
		FileWriter ystatFile = null;
		try{
			fw = new FileWriter(fileNamePrefix+fileNameSuffix);
			xstatFile = new FileWriter(fileNamePrefix+"-x.spc");
			ystatFile = new FileWriter(fileNamePrefix+"-y.spc");
			xstatFile.write("m\tVm\n");
			ystatFile.write("m\tVm\n");
			for(int i=0;i<total;i++){
				x[i] = x[i] / (number/max);
				y[i] = y[i] / (number/max); 
				fw.write(x[i] + ","+y[i]+","+"\n");		
				if(i<number){
					xstatFile.write((i+1)+"\t"+(stat_x[i]+1)+"\n");
					ystatFile.write((i+1)+"\t"+(stat_y[i]+1)+"\n");
				}
			}
			fw.close();
			xstatFile.close();
			ystatFile.close();
			
		}catch(Exception e){
			e.printStackTrace();
		}
		return fileNamePrefix+fileNameSuffix;
	}
	
	
	public String generate(int number,int min, int max,String outputFolder){
		
		System.out.println("start to generate zipf distribution: "+ System.currentTimeMillis());
		
		if(outputFolder != null){
			fileNamePrefix = outputFolder+"/"+fileNamePrefix;
		}				
					
		RandomDataImpl randomData1 = new RandomDataImpl();
		RandomDataImpl randomData2 = new RandomDataImpl(); 
		RandomDataImpl randomData3 = new RandomDataImpl();		

		randomData3.reSeed(1);
		// normailze the value into the given value range
		System.out.println("===normalized==and start to write=");
		FileWriter fw = null;
		try{
			fw = new FileWriter(fileNamePrefix+fileNameSuffix,true);
			int range = 100;
			int interval = number/range;
			for(int j=0;j<interval;j++){
				randomData1.reSeed((j+1));
				randomData2.reSeed((j+1)*5);
				// number means the number of points, the range means the value of the zipf distribution(number of points generated by the distribution)				
				for(int i=0;i<range;i++){		
					double x = randomData1.nextZipf(range, 1) + randomData3.nextUniform(0, 1);
					double y = randomData2.nextZipf(range, 1) + randomData3.nextUniform(0,1);
					x = x / (range/max);
					y = y / (range/max);
					fw.write(x + ","+y+","+"\n");									
				}		
				fw.flush();	
				System.out.println("Flush Time "+j);
			}

			fw.close();
			
		}catch(Exception e){
			e.printStackTrace();
		}
				
		System.out.println("Finish zipf distribution generation: "+ System.currentTimeMillis());
		
		return fileNamePrefix+fileNameSuffix;
	}	
	
	/**
	 * For Testing
	 * @param number
	 */
	public void zipf2D(int number){		
		RandomDataImpl randomData2 = new RandomDataImpl();
		
		int x[] = new int[number];
		int y[] = new int[number];		
		
		
		RandomDataImpl randomData1 = new RandomDataImpl();
		randomData1.reSeed(5);
		randomData2.reSeed(10);
		for(int i=0;i<number;i++){
			x[i] = randomData1.nextZipf(number,1);
			y[i] = randomData2.nextZipf(number,1);
			System.out.println(x[i]+","+y[i]);
		}		
	}
	
	
	
	public static void main(String []args){
		XZipfDistribution distribution = new XZipfDistribution();
		distribution.generate(1000,0,100,".");
		
	}
}
